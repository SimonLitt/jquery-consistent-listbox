(l=>{l.widget("simonlitt.listbox",{options:{multiSelect:!1,name:"lb_name",quiet:!1,autoSort:!1,sortOrder:null,sortable:!1,sortOrderStep:10},_create:function(){this._item_data=new Map,this.options.items&&(this._load_items(this.options.items),delete this.options.items),this.element.addClass("ui-menu").addClass("ui-widget").addClass("ui-widget-content").addClass("ui-corner-all"),this.options.sortable&&!this.options.autoSort&&this.element.addClass("lb-sortable"),this.element.delegate("input","change",l.proxy(this._itemChange,null,this)),this.element.delegate("input","click",l.proxy(this._itemClick,null,this)),this.options.sortable&&!this.options.autoSort&&this._set_sortable(),this._last_val=this.options.multiSelect?this._sorted_vals():this.val(),this._wait_reorder=!1},_reorder:function(){let t=this,e=1;this.element.find("input").each(function(){t.setItemDataVar(l(this).val(),"sort_order",e),e+=t.options.sortOrderStep})},_set_sortable:function(){let i=this;this.element.sortable({change:function(t,e){this._wait_reorder=!0},stop:function(t,e){this._wait_reorder&&(this._wait_reorder=!1,i._reorder())}})},_item_html:function(t,e,i,s){return'<label class="ui-menu-item ui-menu-item-wrapper ui-corner-all'+(s?" ui-state-active":"")+(i?" "+i:"")+'" title="'+t+'"><input type="'+(this.options.multiSelect?"checkbox":"radio")+'"'+(this.options.name?' name="'+this.options.name+'"':"lb_name")+' class="form-check-input" value="'+e+'"'+(s?' checked="checked"':"")+'/><span class="item-text">'+t+"</span>"+(this.options.sortable&&!this.options.autoSort?'<i class="fas fa-sort drag-icon"></i>':"")+"</label>"},index:function(){return this.getItemIndex(this.val())},getItemIndex:function(t){return this.element.find("input[value='"+t+"']").closest(".ui-menu-item").index()},_insert:function(t,e,i){var s=e.hasOwnProperty("val")?String(e.val):"";if(this._item_data.has(s))return!1;var n=e.hasOwnProperty("text")?String(e.text):"",a=!!e.hasOwnProperty("checked")&&e.checked,r=(a&&!this.options.multiSelect&&this._uncheck_all(),e.hasOwnProperty("class")?String(e.class):"");let o=e.hasOwnProperty("sort_order")?parseInt(e.sort_order,10):0;this.options.sortable&&this.options.sortOrder&&(o=1+this.options.sortOrderStep*this.length());n=this._item_html(n,s,r,a),0===t?this.element.prepend(n):t&&(r=parseInt(t,10)||0,(a=this.element.find("label.ui-menu-item:nth-child("+ ++r+")")).length)?a.before(n):this.element.append(n),t=e.hasOwnProperty("data")&&"object"==typeof e.data?e.data:{};return o&&(t.sort_order=o),this._item_data.set(s,t),!0},add:function(t,e=!1,i=null){this._insert(null,t)&&(this.options.autoSort&&this.sort(this.options.sortOrder),this._change(e,i))},insert:function(t,e,i=!1,s=null){this._insert(t,e)&&(this.options.autoSort&&this.sort(this.options.sortOrder),this._change(i,s))},remove:function(e=!1,i=null){var s=this.element.find("input:checked"),t=s.length;if(t){let t=this;s.each(function(){t._item_data.delete(l(this).val())}),s.off().parent().remove(),this.options.autoSort&&this.sort(this.options.sortOrder),this._change(e,i)}return t},delete:function(t,e=!1,i=null){var s=this.element.find("input[value='"+t+"']"),n=s.length;return n&&(this._item_data.delete(String(t)),s.off().parent().remove(),this.options.autoSort&&this.sort(this.options.sortOrder),this._change(e,i)),n},_clear:function(t){var e=this.element.find("input"),i=Boolean(e.length);return i&&(e.off().parent().remove(),this._item_data.clear()),i},clear:function(t=!1,e=null){this._clear(e)&&this._change(t,e)},_load_items:function(t){if(t&&Array.isArray(t)&&t.length){for(var e of t)this._insert(null,e);this.options.autoSort&&this.sort(this.options.sortOrder)}},replace:function(t,e=!1,i=null){this._clear(i),this._load_items(t),this._change(e,i)},length:function(){return this.element.find("input").length},val:function(){var t=this.element.find("input:checked");return t.length?t.val():null},hasSelected:function(){return Boolean(this.element.find("input:checked").length)},vals:function(){let t=[];return this.element.find("input:checked").each(function(){t.push(l(this).val())}),t},sort:function(r=null){let o=this;this.element.html(l(this.element.find("label.ui-menu-item").toArray().sort(function(t,e){let i,s;if(null===r)i=l(t).find("span.item-text").text(),s=l(e).find("span.item-text").text();else if(i=l(t).find("input.form-check-input").val(),s=l(e).find("input.form-check-input").val(),r){var n=parseInt(o.getItemDataVar(i,"sort_order"),10)||0,a=parseInt(o.getItemDataVar(s,"sort_order"),10)||0;if(n!==a)return n-a;i=l(t).find("span.item-text").text(),s=l(e).find("span.item-text").text()}return i.localeCompare(s)})))},getSortOrder:function(){return getItemDataVar(this.val(),"sort_order")},setSortOrder:function(t){this.setItemDataVar(this.val(),"sort_order",t)},getText:function(){return this.getItemText(this.val())},setText:function(t){this.setItemText(this.val(),t)},getItemText:function(t){return this.element.find("input[value='"+t+"']").parent().find("span.item-text").text()},setItemText:function(t,e){this.element.find("input[value='"+t+"']").parent().find("span.item-text").text(e)},getAllData:function(e=!1,i=""){let s=this,n={};return this.element.find("input").each(function(){var t=l(this).val();n[t]=s.getItemData(t),e&&(n[t][i||"text"]=l(this).parent().find("span.item-text").text())}),n},item:function(t=!0){return this._getItem(this.val(),t)},items:function(t=!0){let e=this,i=[];return this.element.find("input:checked").each(function(){i.push(e._getItem(l(this).val(),t))}),i},hasItem:function(t){return Boolean(this.element.find("input[value='"+t+"']").length)},_getItem:function(t,e){return e?{val:t,text:this.getItemText(t),data:this.getItemData(t)}:{val:t,text:this.getItemText(t)}},getItem:function(t,e=!0){return this.hasItem(t)?this._getItem(t,e):null},getData:function(){return this.getItemData(this.val())},updateData:function(t,e=!1,i=""){this.updateItemData(this.val(),t,e,i)},replaceData:function(t,e=!1,i=""){this.replaceItemData(this.val(),t,e,i)},getItemData:function(t){return null!==t&&(t=String(t),this._item_data.has(t))?this._item_data.get(t):null},updateItemData:function(t,e,s=!1,n=""){if(null!==t){var a=String(t);if(this._item_data.has(a)){"object"!=typeof i&&(i={});n=n||"text";s&&i.hasOwnProperty(n)&&this.setItemText(t,i[n]);let i=this._item_data.get(a);Object.entries(i).forEach(([t,e])=>{i[t]=e})}}},replaceItemData:function(t,e,i=!1,s=""){var n;null!==t&&(n=String(t),this._item_data.has(n))&&("object"!=typeof e&&(e={}),n=s||"text",i&&e.hasOwnProperty(n)&&this.setItemText(t,e[n]),this._item_data.set(e))},getDataVar:function(t){return this.getItemDataVar(this.val(),t)},setDataVar:function(t,e){this.setItemDataVar(this.val(),t,e)},unsetDataVar:function(t){this.unsetItemDataVar(this.val(),t)},getItemDataVar:function(t,e){if(null===t)return null;var t=String(t);let i=null;return i=this._item_data.has(t)&&(t=this._item_data.get(t)).hasOwnProperty(e)?t[e]:i},setItemDataVar:function(t,e,i){null!==i&&(t=String(t),this._item_data.has(t))&&(this._item_data.get(t)[e]=i)},unsetItemDataVar:function(t,e){null!==t&&(t=String(t),this._item_data.has(t))&&(t=this._item_data.get(t)).hasOwnProperty(e)&&delete t[e]},_sorted_vals:function(){return this.vals().sort()},_setOption:function(t,e){let i=!1;switch(t){case"multiSelect":this.element.find("input").attr("type",e?"checkbox":"radio"),this._last_val=e?this._sorted_vals():this.val();break;case"name":e?this.element.find("input").attr("name",e):this.element.find("input").removeAttr("name");break;case"sortable":e?this.options.sortable||this.options.autoSort||this._set_sortable():this.options.sortable&&!this.options.autoSort&&this.element.sortable("destroy");break;case"autoSort":e?this.options.sortable&&!this.options.autoSort&&this.element.sortable("destroy"):this.options.sortable&&this.options.autoSort&&this._set_sortable();break;case"sortOrderStep":i=!0}this._super(t,e),i&&this._reorder()},_setOptions:function(t){var i=this;l.each(t,function(t,e){i._setOption(t,e)})},_destroy:function(){this.element.removeClass("ui-menu").removeClass("ui-widget").removeClass("ui-widget-content").removeClass("ui-corner-all").removeClass("lb-sortable"),this.element.html(""),this.element.off("click","input"),this.options.sortable&&!this.options.autoSort&&this.element.sortable("destroy")},_uncheck_all:function(){this.element.find("label.ui-state-active").removeClass("ui-state-active")},_itemClick:function(t,e){var i=l(this);t._trigger("onClick",e,i.val())},_itemChange:function(t,e){var i=l(this);t.options.multiSelect?i.prop("checked")?i.parent().addClass("ui-state-active"):i.parent().removeClass("ui-state-active"):(t._uncheck_all(),i.prop("checked")&&i.parent().addClass("ui-state-active")),t._change(!1,e)},_change:function(t,e){if(!this.options.quiet)if(this.options.multiSelect){let i=this._sorted_vals();i.length===this._last_val.length&&this._last_val.every(function(t,e){return t===i[e]})||(t||this._trigger("onChange",e,{cur:i,old:this._last_val}),this._last_val=i)}else{var i=this.val();i!==this._last_val&&(t||this._trigger("onChange",e,{cur:i,old:this._last_val}),this._last_val=i)}}})})(jQuery);