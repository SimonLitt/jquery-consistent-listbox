/*! @preserve
 * jquery-consistent-listbox v0.1.2-dev (https://github.com/SimonLitt/jquery-consistent-listbox/)
 * Copyright 2025 Simon Litt.
 * @license Licensed under MIT (https://github.com/SimonLitt/jquery-consistent-listbox/blob/main/LICENSE)
 */
(l=>{l.widget("simonlitt.jquery-consistent-listbox",{options:{multiSelect:!1,name:"",quiet:!1,autoSort:!1,sortOrder:null,isSortByDataProp:null,sortable:!1,sortOrderStep:10},_create:function(){this._item_data=new Map,this.options.items&&(this._load_items(this.options.items),delete this.options.items),this.element.addClass("ui-menu").addClass("ui-widget").addClass("ui-widget-content").addClass("ui-corner-all"),this.element.delegate("input","change",l.proxy(this._itemChange,null,this)),this.element.delegate("input","click",l.proxy(this._itemClick,null,this)),this.options.sortable&&(this.options.autoSort?this._sort_opt_warning():this._set_sortable()),this._last_val=this.options.multiSelect?this._sorted_vals():this.val(),this._wait_reorder=!1},_sort_opt_warning:function(){console.warn('simonlitt.listbox widget: because of the "autoSort" option the "sortable" option is ignored!')},_get_sort_key:function(){return this.options.sortOrder||"sort_order"},_reorder:function(){let t=this,e=1;this.element.find("input").each(function(){t.setItemDataVar(l(this).val(),t._get_sort_key(),e),e+=t.options.sortOrderStep})},_set_sortable:function(){this.element.addClass("lb-sortable");let i=this;this.element.sortable({change:function(t,e){this._wait_reorder=!0},stop:function(t,e){this._wait_reorder&&(this._wait_reorder=!1,i._reorder())}}),this.element.disableSelection()},_sortable_html:function(){return'<i class="drag-icon"></i>'},_switch_to_unsortable:function(){this.element.sortable("destroy"),this.element.find("label.ui-menu-item > i.drag-icon").remove(),this.element.removeClass("lb-sortable")},_switch_to_sortable:function(){this.element.find("label.ui-menu-item").append(this._sortable_html()),this._set_sortable()},_get_html_name:function(){return this.options.name||"lb_name"+this.uuid},_item_html:function(t,e,i,n){return'<label class="ui-menu-item ui-menu-item-wrapper ui-corner-all'+(n?" ui-state-active":"")+(i?" "+i:"")+'" title="'+t+'"><input type="'+(this.options.multiSelect?"checkbox":"radio")+'" name="'+this._get_html_name(this.options.name)+'" class="form-check-input" value="'+e+'"'+(n?' checked="checked"':"")+'/><span class="item-text">'+t+"</span>"+(this.options.sortable&&!this.options.autoSort?this._sortable_html():"")+"</label>"},index:function(){return this.getItemIndex(this.val())},getItemIndex:function(t){return this.element.find("input[value='"+t+"']").closest(".ui-menu-item").index()},_insert:function(t,e){var i=e.hasOwnProperty("val")?String(e.val):"";if(this._item_data.has(i))return!1;var n=e.hasOwnProperty("text")?String(e.text):"",s=!!e.hasOwnProperty("checked")&&e.checked,a=(s&&!this.options.multiSelect&&this._uncheck_all(),e.hasOwnProperty("class")?String(e.class):"");let r=null;e.hasOwnProperty("sort_order")&&(r=parseInt(e.sort_order,10)||0,this.options.sortable)&&(r=1+this.options.sortOrderStep*this.length());n=this._item_html(n,i,a,s),0===t?this.element.prepend(n):t&&(a=parseInt(t,10)||0,(s=this.element.find("label.ui-menu-item:nth-child("+ ++a+")")).length)?s.before(n):this.element.append(n),t=e.hasOwnProperty("data")&&"object"==typeof e.data?e.data:{};return null!==r&&(t[this._get_sort_key()]=r),this._item_data.set(i,t),!0},add:function(t,e=!1,i=null){this._insert(null,t)&&(this.options.autoSort&&this.sort(),this._change(e,i))},insert:function(t,e,i=!1,n=null){this._insert(t,e)&&(this.options.autoSort&&this.sort(),this._change(i,n))},remove:function(e=!1,i=null){var n=this.element.find("input:checked"),t=n.length;if(t){let t=this;n.each(function(){t._item_data.delete(l(this).val())}),n.off().parent().remove(),this._change(e,i)}return t},delete:function(t,e=!1,i=null){var n=this.element.find("input[value='"+t+"']"),s=n.length;return s&&(this._item_data.delete(String(t)),n.off().parent().remove(),this._change(e,i)),s},_clear:function(t){var e=this.element.find("input"),i=Boolean(e.length);return i&&(e.off().parent().remove(),this._item_data.clear()),i},clear:function(t=!1,e=null){this._clear(e)&&this._change(t,e)},_load_items:function(t){if(t&&Array.isArray(t)&&t.length){for(var e of t)this._insert(null,e);this.options.autoSort&&this.sort()}},replace:function(t,e=!1,i=null){this._clear(i),this._load_items(t),this._change(e,i)},length:function(){return this.element.find("input").length},val:function(){var t=this.element.find("input:checked");return t.length?t.val():null},hasSelected:function(){return Boolean(this.element.find("input:checked").length)},vals:function(){let t=[];return this.element.find("input:checked").each(function(){t.push(l(this).val())}),t},sort:function(){this.sortBy(this.options.isSortByDataProp)},sortBy:function(r=null){let o=this;this.element.html(l(this.element.find("label.ui-menu-item").toArray().sort(function(t,e){let i,n;if(null===r)i=l(t).find("span.item-text").text(),n=l(e).find("span.item-text").text();else if(i=l(t).find("input.form-check-input").val(),n=l(e).find("input.form-check-input").val(),r){var s=parseInt(o.getItemDataVar(i,o._get_sort_key()),10)||0,a=parseInt(o.getItemDataVar(n,o._get_sort_key()),10)||0;if(s!==a)return s-a;i=l(t).find("span.item-text").text(),n=l(e).find("span.item-text").text()}return i.localeCompare(n,void 0,{numeric:!0})})))},getSortOrder:function(){return this.getItemDataVar(this.val(),this._get_sort_key())},setSortOrder:function(t){"number"!=typeof t&&(t=parseInt(t,10)||0),this.setItemDataVar(this.val(),this._get_sort_key(),t)},getText:function(){return this.getItemText(this.val())},setText:function(t){this.setItemText(this.val(),t)},getItemText:function(t){return this.element.find("input[value='"+t+"']").parent().find("span.item-text").text()},setItemText:function(t,e){this.element.find("input[value='"+t+"']").parent().find("span.item-text").text(e)},getAllData:function(t=!1,e=!1,i=""){let n=this,s;return t?(s=[],this.element.find("input").each(function(){var t=l(this).val();data=n.getItemData(t),e&&(data[i||"text"]=l(this).parent().find("span.item-text").text()),s.push(data)})):(s={},this.element.find("input").each(function(){var t=l(this).val();s[t]=n.getItemData(t),e&&(s[t][i||"text"]=l(this).parent().find("span.item-text").text())})),s},item:function(t=!0){return this._getItem(this.val(),t)},items:function(t=!0){let e=this,i=[];return this.element.find("input:checked").each(function(){i.push(e._getItem(l(this).val(),t))}),i},hasItem:function(t){return Boolean(this.element.find("input[value='"+t+"']").length)},_getItem:function(t,e){return e?{val:t,text:this.getItemText(t),data:this.getItemData(t)}:{val:t,text:this.getItemText(t)}},getItem:function(t,e=!0){return this.hasItem(t)?this._getItem(t,e):null},getData:function(){return this.getItemData(this.val())},updateData:function(t,e=!1,i=""){this.updateItemData(this.val(),t,e,i)},replaceData:function(t,e=!1,i=""){this.replaceItemData(this.val(),t,e,i)},getItemData:function(t){return null!==t&&(t=String(t),this._item_data.has(t))?this._item_data.get(t):null},updateItemData:function(t,e,n=!1,s=""){if(null!==t){var a=String(t);if(this._item_data.has(a)){"object"!=typeof e&&(e={});s=s||"text";n&&e.hasOwnProperty(s)&&this.setItemText(t,e[s]);let i=this._item_data.get(a);Object.entries(e).forEach(([t,e])=>{i[t]=e})}}},replaceItemData:function(t,e,i=!1,n=""){var s;null!==t&&(s=String(t),this._item_data.has(s))&&("object"!=typeof e&&(e={}),n=n||"text",i&&e.hasOwnProperty(n)&&this.setItemText(t,e[n]),this._item_data.set(s,e))},select:function(e,t=!1,i=null){if(this._uncheck_all(),this.element.find("input.form-check-input").prop("checked",!1),null!==e||void 0===e){let t;if(Array.isArray(e))for(var n of e)t=this.element.find("input.form-check-input[value='"+n+"']").prop("checked",!0),this._itemSetMark(this,t);else t=this.element.find("input.form-check-input[value='"+e+"']").prop("checked",!0),this._itemSetMark(this,t)}this._change(t,i)},setVal:function(t,e=!1,i=null){this.setItemVal(this.val(),t,e,i)},setItemVal:function(t,e,i=!1,n=null){this.element.find("input[value='"+t+"']").val(e);var s=this.getItemData(t);String(t);s&&this._item_data.delete(String(t)),this._item_data.set(String(e),s),this._change(i,n)},getDataVar:function(t){return this.getItemDataVar(this.val(),t)},setDataVar:function(t,e){this.setItemDataVar(this.val(),t,e)},unsetDataVar:function(t){this.unsetItemDataVar(this.val(),t)},getItemDataVar:function(t,e){if(null===t)return null;var t=String(t);let i=null;return i=this._item_data.has(t)&&(t=this._item_data.get(t)).hasOwnProperty(e)?t[e]:i},setItemDataVar:function(t,e,i){null!==i&&(t=String(t),this._item_data.has(t))&&(this._item_data.get(t)[e]=i)},unsetItemDataVar:function(t,e){null!==t&&(t=String(t),this._item_data.has(t))&&(t=this._item_data.get(t)).hasOwnProperty(e)&&delete t[e]},_sorted_vals:function(){return this.vals().sort()},_setOption:function(t,e){let i=!1,n=!1;switch(t){case"multiSelect":this.element.find("input").attr("type",e?"checkbox":"radio"),this._last_val=e?this._sorted_vals():this.val();break;case"name":this.element.find("input.form-check-input").attr("name",this._get_html_name(e));break;case"sortable":e?this.options.sortable||this.options.autoSort||this._switch_to_sortable():this.options.sortable&&!this.options.autoSort&&this._switch_to_unsortable();break;case"autoSort":e?(this.options.sortable&&!this.options.autoSort&&this._switch_to_unsortable(),n=!0):this.options.sortable&&this.options.autoSort&&this._switch_to_sortable();break;case"sortOrderStep":i=!0;break;case"isSortByDataProp":this.options.autoSort&&(n=!0)}this._super(t,e),i&&this._reorder(),n&&this.sort()},_setOptions:function(t){var i=this;l.each(t,function(t,e){i._setOption(t,e)})},_destroy:function(){this.element.removeClass("ui-menu").removeClass("ui-widget").removeClass("ui-widget-content").removeClass("ui-corner-all").removeClass("lb-sortable"),this.element.html(""),this.element.off("click","input"),this.options.sortable&&!this.options.autoSort&&this.element.sortable("destroy")},_uncheck_all:function(){this.element.find("label.ui-state-active").removeClass("ui-state-active")},_itemClick:function(t,e){var i=l(this);t._trigger("onClick",e,i.val())},_itemSetMark:function(t,e){t.options.multiSelect?e.prop("checked")?e.parent().addClass("ui-state-active"):e.parent().removeClass("ui-state-active"):(t._uncheck_all(),e.prop("checked")&&e.parent().addClass("ui-state-active"))},_itemChange:function(t,e){t._itemSetMark(t,l(this)),t._change(!1,e)},_change:function(t,e){if(!this.options.quiet)if(this.options.multiSelect){let i=this._sorted_vals();i.length===this._last_val.length&&this._last_val.every(function(t,e){return t===i[e]})||(t||this._trigger("onChange",e,{cur:i,old:this._last_val}),this._last_val=i)}else{var i=this.val();i!==this._last_val&&(t||this._trigger("onChange",e,{cur:i,old:this._last_val}),this._last_val=i)}}})})(jQuery);